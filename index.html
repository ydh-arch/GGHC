<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 유튜브 재생을 위한 referrer 정책 설정 -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>글로벌게임허브센터 입주사 안내</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Gowun Batang', serif; }
        #modal-content, #event-modal-content { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .content-section { display: none; }
        .preserve-lines { white-space: pre-wrap; word-break: break-word; }
        .aspect-video-custom { aspect-ratio: 16 / 9; }
        
        /* 배경 이미지 애니메이션 */
        #bg-image-container { transition: opacity 1s ease-in-out; }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 relative min-h-screen">

    <!-- 배경 이미지 영역 -->
    <div id="bg-image-container" class="fixed inset-0 -z-20 bg-cover bg-center bg-no-repeat opacity-0"></div>
    <!-- 배경 오버레이 -->
    <div id="bg-overlay" class="fixed inset-0 -z-10 bg-pink-50/90 backdrop-blur-sm transition-colors duration-700"></div>

    <header class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-10 transition-colors duration-500" id="main-header">
        <div class="container mx-auto px-6 py-4">
            <h1 id="header-title" class="text-3xl font-bold text-center text-pink-900"></h1>
            <p id="header-subtitle" class="text-center text-pink-800 opacity-80 mt-2"></p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="loading-indicator" class="text-center py-16">
            <p class="text-lg text-gray-500">데이터를 불러오는 중입니다...</p>
        </div>
        <div id="error-message" class="hidden text-center py-16 bg-red-100 text-red-700 rounded-lg">
             <p class="text-lg font-bold">데이터를 불러오는 데 실패했습니다.</p>
             <p class="mt-2">구글 시트 URL과 공유 설정을 다시 확인해 주세요.</p>
        </div>
        <section class="mb-12 bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-lg content-section">
            <h2 class="text-2xl font-bold text-center text-pink-900 mb-4">글로벌게임허브센터 소개</h2>
            <p id="introduction-text" class="text-gray-700 leading-relaxed text-center max-w-3xl mx-auto preserve-lines"></p>
        </section>
        <section class="mb-12 content-section">
            <h2 class="text-2xl font-bold text-center text-pink-900 mb-6">주요 행사 안내</h2>
            <div id="event-list" class="grid md:grid-cols-2 gap-6"></div>
        </section>
        <section class="content-section">
            <h2 class="text-2xl font-bold text-center text-pink-900 mb-6">입주사 목록</h2>
            <div id="company-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </section>
    </main>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div class="p-8 md:p-12">
                <div class="flex flex-col sm:flex-row items-start sm:items-center mb-6 border-b pb-6">
                    <div class="w-24 h-24 rounded-full mr-0 sm:mr-6 mb-4 sm:mb-0 bg-white border flex-shrink-0 flex items-center justify-center overflow-hidden">
                        <img id="modal-logo" src="" alt="기업 로고" class="max-w-[80%] max-h-[80%] object-contain" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=No+Image';">
                    </div>
                    <div>
                        <h2 id="modal-name" class="text-3xl font-bold text-gray-900"></h2>
                        <p id="modal-description" class="text-lg text-pink-600 mt-1"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6">
                    <div><strong class="w-24 inline-block">대표명</strong> <span id="modal-ceo"></span></div>
                    <div><strong class="w-24 inline-block">이메일</strong> <span id="modal-email"></span></div>
                    <div><strong class="w-24 inline-block">주력 장르</strong> <span id="modal-genre"></span></div>
                    <div><strong class="w-24 inline-block">주력 플랫폼</strong> <span id="modal-platform"></span></div>
                </div>
                 <div class="mb-8">
                    <h3 class="text-xl font-bold mb-2 text-gray-800">기업 소개</h3>
                    <p id="modal-detailed-description" class="text-gray-600 leading-relaxed preserve-lines"></p>
                </div>
                <div class="bg-pink-50 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">대표 게임</h3>
                    <p id="modal-main-game" class="text-2xl font-semibold text-pink-700 mb-2"></p>
                    <p id="modal-game-description" class="text-gray-600 leading-relaxed preserve-lines"></p>
                </div>
                <div id="youtube-section" class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">소개 영상</h3>
                    <div class="aspect-video-custom">
                         <iframe id="youtube-iframe" class="w-full h-full" 
                                 referrerpolicy="strict-origin-when-cross-origin"
                                 frameborder="0" 
                                 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                 allowfullscreen>
                         </iframe>
                    </div>
                </div>
                <div id="game-image-section" class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">게임 이미지</h3>
                    <div id="modal-game-images" class="grid grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="event-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div id="event-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button id="event-modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <div class="p-6 md:p-8">
                <!-- 포스터 이미지 링크 -->
                <a id="event-modal-poster-link" href="#" target="_blank" class="block transition-transform hover:opacity-95">
                    <img id="event-modal-poster" src="" alt="행사 포스터" class="w-full h-auto rounded-lg shadow-md mb-6" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='https://placehold.co/600x400?text=No+Image';">
                </a>
                <h2 id="event-modal-title" class="text-3xl font-bold text-gray-900 mb-4"></h2>
                <div id="event-modal-description" class="text-gray-600 leading-relaxed preserve-lines"></div>
            </div>
        </div>
    </div>

    <footer class="bg-pink-900 text-white mt-8 py-4">
        <div class="container mx-auto px-6 text-center">
            <p id="footer-text" class="opacity-80"></p>
        </div>
    </footer>

    <script>
        const introductionSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSzp3Fm7roXu9KK-P88_s4Ki8KMq8cPvOn2LTx_d8fyAlHRflImemJGu2nsPc7VXfKqGimNA7IW4R0D/pub?gid=1613561003&single=true&output=csv';
        const companiesSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSzp3Fm7roXu9KK-P88_s4Ki8KMq8cPvOn2LTx_d8fyAlHRflImemJGu2nsPc7VXfKqGimNA7IW4R0D/pub?gid=0&single=true&output=csv';
        const eventsSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSzp3Fm7roXu9KK-P88_s4Ki8KMq8cPvOn2LTx_d8fyAlHRflImemJGu2nsPc7VXfKqGimNA7IW4R0D/pub?gid=1788825445&single=true&output=csv';

        function convertToDirectLink(url) {
            if (!url) return '';
            const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            if (idMatch && idMatch[1]) {
                return `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=s4000`;
            }
            return url;
        }

        function getFallbackImage(width = 200, height = 200) {
            return `https://placehold.co/${width}x${height}?text=No+Image`;
        }

        // [수정됨] 텍스트 파싱: 링크 끝에 붙은 특수문자 제거 기능 강화
        function parseTextToHtml(text) {
            if (!text) return '';
            
            let content = text.replace(/\\n/g, '\n');
            content = content.replace(/\n/g, '<br>');

            // 1. 마크다운 스타일 링크 ([텍스트](주소))
            content = content.replace(
                /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
                '<a href="$2" target="_blank" class="text-blue-600 hover:underline relative z-10" onclick="event.stopPropagation();">$1</a>'
            );

            // 2. 일반 URL 자동 변환 (끝에 붙은 괄호, 점, 콤마 등 자동 제거)
            content = content.replace(
                /(href="https?:\/\/[^"]+")|(https?:\/\/[^\s<]+)/g, 
                function(match, existingLink, plainUrl) {
                    if (existingLink) return existingLink; // 이미 a태그인 경우 패스
                    
                    // URL 끝에 붙은 문장부호들 제거 (예: (주소), 주소. 주소, 등)
                    let url = plainUrl;
                    let trailing = '';
                    
                    // 반복해서 끝의 특수문자를 잘라냄 (URL에 포함되지 않는 문자들)
                    while (/[.,;:)\]}'"]$/.test(url)) {
                        trailing = url.slice(-1) + trailing;
                        url = url.slice(0, -1);
                    }
                    
                    if (!url) return match; // URL이 없으면 원본 반환

                    return '<a href="' + url + '" target="_blank" class="text-blue-600 hover:underline relative z-10" onclick="event.stopPropagation();">' + url + '</a>' + trailing;
                }
            );

            return content;
        }

        function parseCSV(text) {
            const arr = [];
            let quote = false;
            let col = 0, row = 0;
            
            for (let c = 0; c < text.length; c++) {
                let cc = text[c], nc = text[c+1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';

                if (cc === '"' && quote && nc === '"') { 
                    arr[row][col] += cc; ++c; continue; 
                }
                if (cc === '"') { 
                    quote = !quote; continue; 
                }
                if (cc === ',' && !quote) { 
                    ++col; continue; 
                }
                if (cc === '\r' && nc === '\n' && !quote) { 
                    ++row; col = 0; ++c; continue; 
                }
                if (cc === '\n' && !quote) { 
                    ++row; col = 0; continue; 
                }
                if (cc === '\r' && !quote) { 
                    ++row; col = 0; continue; 
                }

                arr[row][col] += cc;
            }

            if (arr.length === 0) return [];
            const headers = arr[0].map(h => h.trim());
            const result = [];
            for (let i = 1; i < arr.length; i++) {
                const rowData = arr[i];
                if (rowData.length < 1 || (rowData.length === 1 && rowData[0] === '')) continue; 
                
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = rowData[j] ? rowData[j].trim() : '';
                }
                result.push(obj);
            }
            return result;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const [introResponse, eventsResponse, companiesResponse] = await Promise.all([
                    fetch(introductionSheetURL), fetch(eventsSheetURL), fetch(companiesSheetURL)
                ]);
                if (!introResponse.ok || !eventsResponse.ok || !companiesResponse.ok) throw new Error('Network error');

                const [introCSV, eventsCSV, companiesCSV] = await Promise.all([
                    introResponse.text(), eventsResponse.text(), companiesResponse.text()
                ]);

                const introData = parseCSV(introCSV);
                const eventsData = parseCSV(eventsCSV);
                const companiesData = parseCSV(companiesCSV).map(c => ({
                    ...c, 
                    gameImages: c.gameImages ? c.gameImages.split(',').map(url => convertToDirectLink(url.trim())) : [] 
                }));
                
                renderHeaderAndIntroduction(introData);
                renderEvents(eventsData);
                renderCompanies(companiesData);

                document.getElementById('loading-indicator').style.display = 'none';
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'block');
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('error-message').classList.remove('hidden');
            }
            
            document.getElementById('modal-close-btn').addEventListener('click', closeCompanyModal);
            document.getElementById('modal-backdrop').addEventListener('click', closeCompanyModal);
            document.getElementById('event-modal-close-btn').addEventListener('click', closeEventModal);
            document.getElementById('event-modal-backdrop').addEventListener('click', closeEventModal);
        });
        
        function renderHeaderAndIntroduction(data) {
            if (data.length > 0 && data[0]) {
                document.getElementById('header-title').textContent = data[0].title || '글로벌게임허브센터';
                document.getElementById('header-subtitle').textContent = data[0].subtitle || '홈페이지 방문을 환영합니다.';
                document.getElementById('footer-text').textContent = data[0].footerText || '© 2024 Your Company. All Rights Reserved.';
                applyLineBreaks('introduction-text', data[0].text);

                if (data[0].backgroundImage) {
                    const bgUrl = convertToDirectLink(data[0].backgroundImage);
                    const bgContainer = document.getElementById('bg-image-container');
                    const bgOverlay = document.getElementById('bg-overlay');
                    
                    if (bgUrl) {
                        bgContainer.style.backgroundImage = `url('${bgUrl}')`;
                        bgContainer.classList.remove('opacity-0'); 
                        bgOverlay.classList.remove('bg-pink-50/90');
                        bgOverlay.classList.add('bg-white/70'); 
                    }
                }
            }
        }

        function renderEvents(events) {
            const container = document.getElementById('event-list');
            container.innerHTML = '';
            events.forEach((event, index) => {
                event.posterImage = convertToDirectLink(event.posterImage);
                const eventString = JSON.stringify(event).replace(/'/g, "\\'");
                container.innerHTML += `
                    <div class="bg-white p-6 rounded-lg shadow-lg flex items-start hover:shadow-xl transition-shadow duration-300 cursor-pointer" onclick='openEventModal(${eventString})'>
                        <div class="bg-${event.color}-500 text-white rounded-lg p-3 text-center mr-4 flex-shrink-0">
                            <span class="block text-2xl font-bold">${event.day}</span>
                            <span class="block text-sm uppercase">${event.month}</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${event.title}</h3>
                            <div class="text-gray-600 mt-1 preserve-lines">${parseTextToHtml(event.shortDescription)}</div>
                        </div>
                    </div>`;
            });
        }

        function renderCompanies(companies) {
            const container = document.getElementById('company-grid');
            container.innerHTML = '';
            companies.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            companies.forEach((company, index) => {
                company.logo = convertToDirectLink(company.logo);
                const companyString = JSON.stringify(company).replace(/'/g, "\\'");
                container.innerHTML += `
                    <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer" onclick='openCompanyModal(${companyString})'>
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 rounded-full mr-4 bg-white border flex-shrink-0 flex items-center justify-center overflow-hidden">
                                    <img src="${company.logo}" alt="${company.name} 로고" class="max-w-[80%] max-h-[80%] object-contain" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=No+Image';">
                                </div>
                                <h2 class="text-xl font-bold text-gray-900">${company.name}</h2>
                            </div>
                            <p class="text-gray-700 h-16">${company.description}</p>
                        </div>
                    </div>`;
            });
        }
        
        function applyLineBreaks(elementId, text) {
            const element = document.getElementById(elementId);
            if(element) element.textContent = (text || '').replace(/\\n/g, '\n');
        }

        function convertYoutubeUrlToEmbed(url) {
            if (!url) return null;
            let videoId = '';
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(youtubeRegex);
            if (match) {
                videoId = match[1];
            }
            return videoId ? `https://www.youtube-nocookie.com/embed/${videoId}` : null;
        }

        function openCompanyModal(company) {
            if (!company) return;
            const logoImg = document.getElementById('modal-logo');
            logoImg.src = company.logo; 
            logoImg.onerror = function() { this.src = getFallbackImage(100, 100); };
            
            document.getElementById('modal-name').textContent = company.name;
            document.getElementById('modal-description').textContent = company.description;
            document.getElementById('modal-ceo').textContent = company.ceo;
            document.getElementById('modal-email').textContent = company.email;
            document.getElementById('modal-main-game').textContent = company.mainGame;
            document.getElementById('modal-genre').textContent = company.genre;
            document.getElementById('modal-platform').textContent = company.platform;
            
            applyLineBreaks('modal-detailed-description', company.detailedDescription);
            applyLineBreaks('modal-game-description', company.gameDescription);
            
            const youtubeSection = document.getElementById('youtube-section');
            const youtubeIframe = document.getElementById('youtube-iframe');
            const embedUrl = convertYoutubeUrlToEmbed(company.youtubeURL);

            if (embedUrl) {
                youtubeIframe.src = embedUrl;
                youtubeSection.style.display = 'block';
            } else {
                youtubeIframe.src = '';
                youtubeSection.style.display = 'none';
            }
            
            const gameImageSection = document.getElementById('game-image-section');
            const gameImagesContainer = document.getElementById('modal-game-images');
            gameImagesContainer.innerHTML = ''; 
            if (company.gameImages && company.gameImages.length > 0 && company.gameImages[0]) {
                gameImageSection.style.display = 'block';
                company.gameImages.forEach(imageUrl => {
                    gameImagesContainer.innerHTML += `
                    <div class="flex justify-center items-center">
                        <img src="${imageUrl}" alt="${company.mainGame} 게임 이미지" class="rounded-lg shadow-md max-w-full max-h-80 object-contain mx-auto" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='https://placehold.co/600x400?text=No+Image';">
                    </div>`;
                });
            } else {
                gameImageSection.style.display = 'none';
            }
            document.body.style.overflow = 'hidden';
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }
        
        function closeCompanyModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('youtube-iframe').src = '';
            document.body.style.overflow = '';
        }

        function openEventModal(event) {
            if (!event) return;
            const posterImg = document.getElementById('event-modal-poster');
            posterImg.src = event.posterImage; 
            posterImg.onerror = function() { this.src = getFallbackImage(600, 400); };

            const posterLinkEl = document.getElementById('event-modal-poster-link');
            if (event.posterLink && event.posterLink.trim() !== '') {
                posterLinkEl.href = event.posterLink.trim();
                posterLinkEl.classList.remove('pointer-events-none', 'cursor-default');
                posterLinkEl.classList.add('cursor-pointer');
            } else {
                posterLinkEl.href = '#';
                posterLinkEl.classList.add('pointer-events-none', 'cursor-default');
                posterLinkEl.classList.remove('cursor-pointer');
            }

            document.getElementById('event-modal-title').textContent = event.title;
            document.getElementById('event-modal-description').innerHTML = parseTextToHtml(event.detailedDescription);

            document.body.style.overflow = 'hidden';
            document.getElementById('event-modal-backdrop').classList.remove('hidden');
        }
        function closeEventModal() { 
            document.getElementById('event-modal-backdrop').classList.add('hidden'); 
            document.body.style.overflow = '';
        }
    </script>
</body>
</html>
